

# 第10章 后台默默的劳动者——探究服务

## 10.1 服务是什么
服务依赖于创建服务时所在的应用程序进程。当某个应用程序进程被杀掉时，所有依赖于该进程的服务也会停止运行。


## 10.2 Android 多线程编程
Android 不允许在子线程中进行UI操作。
Android提供了一套**异步消息处理机制**。

### 10.2.3 解析异步消息处理机制

1. Message          线程之间传递的消息。
2. Handler          处理者。发送和处理消息。
3. MessageQueue     消息队列，存放所有通过Handler发送的消息。
4. Looper           每个线程中的MessageQueue的管家。调用 Looper的loop()方法后，进入一个无限循环，当MessageQueue中存在一条消息，就会将它取出。把它传递给Handler的handlerMessage()中。


### 10.2.4 AsyncTask
1. onPreExecute()                   后台任务开始之前调用 。
2. doInBackground(Params...)        执行具体的耗时任务。
3. onProgressUpdate(Progress...)    进行UI操作。    
4. onPostExecute(Result)            执行任务的收尾工作。



## 10.3 服务的基本用法 


### 10.3.1 定义一个服务

```java
package com.example.servicetest;

import android.app.Service;
import android.content.Intent;
import android.os.Binder;
import android.os.IBinder;
import android.util.Log;

public class MyService extends Service {
    private DownloadBinder mBinder = new DownloadBinder();
    class DownloadBinder extends Binder {
        public void startDownload() {
            Log.d("MyService", "startDownload executed");
        }
        public int getProgress() {
            Log.d("MyService", "getProgress executed");
            return 0;
        }
    }

    public MyService() {
    }

    @Override
    public IBinder onBind(Intent intent) {
        // TODO: Return the communication channel to the service.
//        throw new UnsupportedOperationException("Not yet implemented");
        return mBinder;
    }

    // 服务创建的时候调用
    @Override
    public void onCreate() {
        super.onCreate();
        Log.d("MyService", "onCreate executed");
    }

    // 服务启动的时候调用
    @Override
    public int onStartCommand(Intent intent, int flags, int startId) {
        Log.d("MyService", "onStartCommand executed");
        return super.onStartCommand(intent, flags, startId);
    }

    // 服务销毁的时候调用
    @Override
    public void onDestroy() {
        super.onDestroy();
        Log.d("MyService", "onDestroy executed");
    }
}
```


* Exported : 是否允许当前程序之外的其他程序访问这个服务。
* Enabled : 是否启用这个服务。
每个服务需要都需要在AndroidManifest.xml里进行注册才能生效。
```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.servicetest">

    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/AppTheme">
        <service
            android:name=".MyService"
            android:enabled="true"
            android:exported="true"></service>

        <activity android:name=".MainActivity">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />

                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>

</manifest>
```



### 10.3.2 启动和停止服务

startService()和stopService() 都是定义在Context类中的。
也可以在Myservice的任何位置 ，调用 stopSelf() 让这个服务停止 下来。


onCreate() 是第一次创建的时候调用 的。
onStartCommand() 则在每次启动服务的时候调用 。
第一次点都会执行，以后 再点只有onStartCommand()执行。


## 10.4 服务的生命周期


## 10.5 服务的更多技巧




